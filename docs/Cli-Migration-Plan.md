# CLI Migration Tool Plan

This document outlines the implementation plan for a new CLI command that migrates old CLI-generated API projects to the new source-generator setup.

## Overview

**Command**: `atc-rest-api-gen migrate project`

**Purpose**: Automate migration from old CLI tool-based generation (manual script execution) to the new Roslyn source-generator setup (automatic build-time generation).

**Input**:
- Path to existing solution/root directory containing old-generated API projects (required)
- Path to OpenAPI specification file (required) - must be explicit to ensure exactness

---

## Phase 1: Validation & Prerequisites

The first step is validating whether the existing project can be migrated. This includes detecting project structure, verifying required files, and identifying potential blockers.

### 1.1 Project Structure Detection

| Check | Description | Required |
|-------|-------------|----------|
| Solution file | Find `.sln` or `.slnx` file in root | Yes |
| Api.Generated project | Detect `*.Api.Generated.csproj` project | Yes |
| ApiClient.Generated project | Detect `*.ApiClient.Generated.csproj` project | No |
| Domain project | Detect `*.Domain.csproj` with handler implementations | Yes |
| Host API project | Detect main `*.Api.csproj` (non-generated) | Yes |

**Detection Logic**:
```
{RootPath}/
├── *.sln or *.slnx                    → Solution file
├── src/
│   ├── {ProjectName}.Api/             → Host API project
│   ├── {ProjectName}.Api.Generated/   → Server generated code
│   ├── {ProjectName}.ApiClient.Generated/  → Client generated code (optional)
│   └── {ProjectName}.Domain/          → Handler implementations
```

### 1.2 OpenAPI Specification Validation

The specification file path is provided explicitly via the `-p/--spec` argument. This ensures exactness and avoids ambiguity when multiple YAML files exist in a project.

| Check | Description | Required |
|-------|-------------|----------|
| Spec file exists | Verify provided spec path exists | Yes |
| Spec validity | Verify spec is valid OpenAPI 3.x | Yes |
| Spec version | Extract OpenAPI version (3.0.x, 3.1.x) | Info |
| Multi-part specs | Detect related part files (e.g., `api.yaml` + `api_users.yaml`) | No |

**Validation Steps**:
1. Verify file exists at provided path
2. Parse YAML/JSON and validate OpenAPI schema
3. Extract API info (title, version, endpoints count)
4. Check for related multi-part specification files in same directory

### 1.3 Generator Options Detection

| Check | Description | Required |
|-------|-------------|----------|
| Options file | Find `*GeneratorOptions.json` or `*Options.json` | No |
| Options validity | Validate options file format | If found |

**Key Options to Extract**:
- `generator.aspNetOutputType` (MinimalApi vs Controllers)
- `generator.useRestExtended`
- `generator.httpClientName`
- `generator.response.useProblemDetailsAsDefaultBody`
- `validation.strictMode`
- `validation.operationIdCasingStyle`
- `validation.modelNameCasingStyle`
- `validation.modelPropertyNameCasingStyle`

### 1.4 Package Reference Validation

| Check | Description | Required |
|-------|-------------|----------|
| Atc packages | Detect Atc.Rest.* package references | Yes |
| Package versions | Extract current package versions | Yes |
| Incompatible packages | Identify packages that need removal/replacement | Yes |

**Expected Packages in Old Setup**:
```xml
<!-- Api.Generated.csproj -->
<PackageReference Include="Atc" Version="x.x.x" />
<PackageReference Include="Atc.Rest" Version="x.x.x" />
<PackageReference Include="Atc.Rest.MinimalApi" Version="x.x.x" />

<!-- ApiClient.Generated.csproj -->
<PackageReference Include="Atc" Version="x.x.x" />
<PackageReference Include="Atc.Rest" Version="x.x.x" />
<PackageReference Include="Atc.Rest.Client" Version="x.x.x" />
```

### 1.5 Generated Code Markers

| Check | Description | Purpose |
|-------|-------------|---------|
| `[GeneratedCode]` attributes | Files with `ApiGenerator` marker | Identify generated files |
| Assembly marker interfaces | `IApiContractAssemblyMarker`, `IDomainAssemblyMarker` | Understand discovery pattern |
| GlobalUsings.cs | Detect generated global usings | Namespace patterns |
| Generation comments | `// This code was auto-generated by ApiGenerator` | Version detection |

### 1.6 Handler Implementation Analysis

| Check | Description | Required |
|-------|-------------|----------|
| Handler files | Find handler implementations in Domain project | Yes |
| Interface compliance | Handlers implement generated interfaces | Yes |
| Custom code detection | Identify non-generated handler logic | Yes |

**Critical**: Handler implementations contain custom business logic that MUST be preserved during migration.

### 1.7 Target Framework & Language Version Compatibility

| Check | Description | Required |
|-------|-------------|----------|
| Current TFM | Extract TargetFramework from projects | Yes |
| Minimum TFM | Verify >= net8.0 (absolute minimum) | Yes |
| Target TFM | Verify = net10.0 (required for source generator) | Yes |
| Current LangVersion | Extract LangVersion from projects | Yes |
| Target LangVersion | Verify = 14 (C# 14 required) | Yes |

**Target Framework Rules**:
- `< net8.0` → **Blocker**: Cannot migrate, too old
- `net8.0` or `net9.0` → **Prompt**: Requires upgrade confirmation
- `net10.0` → **OK**: Ready for migration

**Language Version Rules**:
- `< 12` → **Blocker**: Cannot migrate, too old
- `12` or `13` → **Prompt**: Requires upgrade confirmation
- `14` → **OK**: Ready for migration

**Upgrade Confirmation Prompt** (when TFM < net10.0 or LangVersion < 14):
```
[yellow]![/] Target framework and language version upgrade required

Current configuration:
  • Target framework: net9.0 → net10.0
  • Language version: C# 13 → C# 14

The source generator requires .NET 10 with C# 14. Migration will update:
  • Directory.Build.props: TargetFramework → net10.0
  • Directory.Build.props: LangVersion → 14
  • All project files referencing older TFMs or LangVersions

Do you want to proceed with the upgrade? [y/N]
```

> **Note**: The source generator (`Atc.Rest.Api.SourceGenerator`) targets `netstandard2.0` for compatibility, but the **generated code** and **consuming projects** require .NET 10 (C# 14) features.

---

## Phase 1 Implementation: Validation Command

### Command Structure

```
atc-rest-api-gen migrate validate -s <solution-path> -p <spec-path> [options]
```

### Command Options

| Option | Description | Default |
|--------|-------------|---------|
| `-s, --solution <PATH>` | Path to solution file or root directory | Required |
| `-p, --spec <PATH>` | Path to OpenAPI specification file (.yaml/.yml/.json) | Required |
| `--verbose` | Show detailed validation output | false |
| `--output-report <PATH>` | Save validation report to file | None |

> **Note**: The specification path (`-p/--spec`) is intentionally required rather than auto-detected. This ensures the user explicitly confirms which specification file should be used for migration, avoiding potential errors from picking the wrong file when multiple specs exist.

### Validation Output

```
ATC REST API
Migration Validator

Solution:      D:\Code\KempLauritzen\kl-iot-d365-api\KL.IoT.D365.slnx
Specification: D:\Code\KempLauritzen\kl-iot-d365-api\src\ScriptAndSpecifications\D365.spec.api.v1.yaml

[blue]Project Structure[/]
  ✓ Solution file found: KL.IoT.D365.slnx
  ✓ Api.Generated project found: KL.IoT.D365.Api.Generated
  ✓ ApiClient.Generated project found: KL.IoT.D365.ApiClient.Generated
  ✓ Domain project found: KL.IoT.D365.Domain
  ✓ Host API project found: KL.IoT.D365.Api

[blue]OpenAPI Specification[/]
  ✓ Specification file exists
  ✓ Valid OpenAPI 3.0.1 document
  • Title: D365 API
  • Endpoints: 2 operations
  • No multi-part specifications detected

[blue]Generator Configuration[/]
  ✓ Options file found: D365ApiGeneratorOptions.json
  • Output type: MinimalApi
  • Problem details: Enabled
  • Strict mode: Enabled

[blue]Package References[/]
  ✓ Atc packages detected (version 3.0.8)
  ✓ Atc.Rest.MinimalApi detected (version 1.0.87)
  ✓ Atc.Rest.Client detected (version 2.0.1)

[blue]Generated Code Analysis[/]
  ✓ Generated files detected: 23 server, 32 client
  ✓ Generator version: 2.0.686
  • Assembly markers: IApiContractAssemblyMarker, IDomainAssemblyMarker

[blue]Handler Analysis[/]
  ✓ Handler implementations found: 2
    • GetAccountsHandler (Accounts)
    • GetAccountHandler (Accounts)

[blue]Target Framework & Language Version[/]
  ✓ Target framework: net9.0 (supported, upgrade required → net10.0)
  ✓ Language version: C# 13 (supported, upgrade required → C# 14)
  [yellow]![/] Upgrade to .NET 10 / C# 14 will be required

═══════════════════════════════════════════════════════════════════
[yellow]! Project is eligible for migration (with .NET 10 / C# 14 upgrade)[/]

Detected configuration:
  • Project name: KL.IoT.D365
  • Namespace root: KL.IoT.D365
  • Generation style: MinimalApi with ProblemDetails
  • Handler count: 2

Run 'atc-rest-api-gen migrate execute -s <solution-path> -p <spec-path>' to perform migration.
═══════════════════════════════════════════════════════════════════
```

### Validation Error Scenarios

| Scenario | Error Message | Blocker |
|----------|---------------|---------|
| No solution file | "No solution file (.sln/.slnx) found in path" | Yes |
| No Api.Generated project | "No Api.Generated project found. Is this an ATC-generated API?" | Yes |
| Spec file not found | "Specification file not found: {path}" | Yes |
| Invalid spec format | "File is not a valid YAML/JSON document: {error}" | Yes |
| Invalid OpenAPI spec | "OpenAPI specification validation failed: {errors}" | Yes |
| Unsupported OpenAPI version | "OpenAPI version {version} not supported. Required: 3.0.x or 3.1.x" | Yes |
| Very old TFM (< net8.0) | "Target framework {tfm} not supported. Minimum: net8.0" | Yes |
| Very old LangVersion (< 12) | "Language version C# {version} not supported. Minimum: C# 12" | Yes |
| Old TFM (net8.0/net9.0) | "Target framework upgrade required: {tfm} → net10.0" | Prompt |
| Old LangVersion (12/13) | "Language version upgrade required: C# {version} → C# 14" | Prompt |
| Upgrade declined | "Migration cancelled. .NET 10 / C# 14 upgrade is required." | Yes |
| Missing Domain project | "No Domain project found. Handler preservation not possible." | Warning |
| Controller-based API | "Controller-based APIs require manual migration steps" | Warning |

---

## Phase 2: Migration Execution

### 2.1 Command Structure

```
atc-rest-api-gen migrate execute -s <solution-path> -p <spec-path> [options]
```

| Option | Description | Default |
|--------|-------------|---------|
| `-s, --solution <PATH>` | Path to solution file or root directory | Required |
| `-p, --spec <PATH>` | Path to OpenAPI specification file | Required |
| `--dry-run` | Preview changes without executing | false |
| `--force` | Skip confirmation prompts (including git check) | false |

### 2.2 Migration Execution Flow

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. Run Validation (Phase 1)                                     │
│    - Reuse all validators from migrate validate                 │
│    - Abort if blocking issues found                             │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 2. Git Status Check                                             │
│    - Check for uncommitted changes (staged or unstaged)         │
│    - Warn user and require confirmation to proceed              │
│    - Skip check if --force flag is set                          │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 3. Confirm Upgrade (if needed)                                  │
│    - Prompt for .NET 10 / C# 14 upgrade if current < required   │
│    - Skip prompt if --force flag is set                         │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 4. Copy Specification                                           │
│    - Create Specifications/ folder in Host API project          │
│    - Copy main spec and any multi-part files                    │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 5. Generate Marker Files                                        │
│    - Create .atc-rest-api-server in Host API project            │
│    - Create .atc-rest-api-client if client project exists       │
│    - Create .atc-rest-api-server-handlers in Domain project     │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 6. Update Project Files                                         │
│    - Add source generator package reference                     │
│    - Add AdditionalFiles for spec and markers                   │
│    - Remove old package references                              │
│    - Update TFM/LangVersion if needed                           │
│    - Remove references to old generated projects                │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 7. Handle ATC Coding Rules                                      │
│    - If config exists: update projectTarget to DotNet10         │
│    - If not exists: prompt to set up (recommended)              │
│    - If accepted: create config and run updater                 │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 8. Clean Generated Projects                                     │
│    - Delete old generated code files from Api.Generated         │
│    - Delete old generated code files from ApiClient.Generated   │
│    - Keep only .csproj and add marker files                     │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 9. Rename Projects                                              │
│    - Rename *.Api.Generated/ → *.Api.Contracts/                 │
│    - Rename *.ApiClient.Generated/ → *.ApiClient/ (if exists)   │
│    - Update .csproj filenames accordingly                       │
│    - Keep Host API project (*.Api/) unchanged                   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 10. Update Solution and References                              │
│     - Update solution file with renamed projects                │
│     - Update Host API to reference Api.Contracts (not Generated)│
│     - Update Domain to reference Api.Contracts                  │
│     - Update other projects referencing old names               │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 11. Update GlobalUsings.cs in Domain                            │
│     - Find GlobalUsings.cs in Domain project                    │
│     - Replace *.Api.Generated.* → *.Api.Contracts.Generated.*   │
│     - Add missing generated namespace usings from OpenAPI spec  │
│       (Handlers, Models, Parameters, Results per path segment)  │
│     - Preserve all other using statements                       │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 12. Build Verification                                          │
│     - Run dotnet build to verify migration                      │
│     - Report success or failure                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2.1 Git Status Check Warning

Before migration begins, the tool checks for uncommitted changes:

```
[yellow]⚠ Warning: Uncommitted changes detected[/]

The following files have uncommitted changes:
  M src/MyProject.Api/Program.cs
  ? src/MyProject.Api/temp.cs

Migration will modify and delete files. Ensure all changes are committed
to git before proceeding so you can easily revert if needed.

Do you want to proceed anyway? [y/N]
```

If `--force` is specified, the warning is displayed but no confirmation is required.

### 2.3 Marker File Generation

**Server Marker** (`.atc-rest-api-server`) - placed in Api.Contracts project (renamed from Api.Generated):
```json
{
  "validateSpecificationStrategy": "Strict",
  "namespace": "KL.IoT.Nexus.Api.Contracts"
}
```

> **Note**: The marker file references the spec via `AdditionalFiles` in the .csproj, not a path in the JSON.

**Client Marker** (`.atc-rest-api-client`) - placed in ApiClient project (renamed from ApiClient.Generated):
```json
{
  "httpClientName": "KL-IoT-Nexus-ApiClient",
  "endpointGenerationType": "EndpointPerOperation"
}
```

**Handler Marker** (`.atc-rest-api-server-handlers`) - placed in Domain project:
```json
{
  "namespace": "KL.IoT.Nexus.Domain.Handlers"
}
```

> **Note**: The spec file stays in its original location (e.g., `ScriptAndSpecifications/`). Each project references it via `AdditionalFiles`.

### 2.4 Project File Modifications

**Api.Contracts Project** (renamed from `*.Api.Generated.csproj` → `*.Api.Contracts.csproj`):
```xml
<ItemGroup>
  <PackageReference Include="Atc.Rest.Api.SourceGenerator"
                    Version="1.0.59"
                    OutputItemType="Analyzer"
                    ReferenceOutputAssembly="false" />
</ItemGroup>

<ItemGroup>
  <!-- Reference spec from original location -->
  <AdditionalFiles Include="..\ScriptAndSpecifications\{SpecFileName}.yaml" />
  <AdditionalFiles Include=".atc-rest-api-server" />
</ItemGroup>
```

**Api.Contracts Project** - Delete all old generated code files:
- Delete `Contracts/` folder and all contents
- Delete `Endpoints/` folder and all contents
- Delete `Resources/` folder (if exists)
- Delete `GlobalUsings.cs` (will be auto-generated)
- Delete `IApiContractAssemblyMarker.cs` (will be auto-generated)
- Keep only `.csproj` file

**ApiClient Project** (renamed from `*.ApiClient.Generated.csproj` → `*.ApiClient.csproj`):
```xml
<ItemGroup>
  <PackageReference Include="Atc.Rest.Api.SourceGenerator"
                    Version="1.0.59"
                    OutputItemType="Analyzer"
                    ReferenceOutputAssembly="false" />
</ItemGroup>

<ItemGroup>
  <AdditionalFiles Include="..\ScriptAndSpecifications\{SpecFileName}.yaml" />
  <AdditionalFiles Include=".atc-rest-api-client" />
</ItemGroup>
```

**ApiClient Project** - Delete all old generated code files:
- Delete `Contracts/` folder and all contents
- Delete `Endpoints/` folder and all contents
- Delete `GlobalUsings.cs` (will be auto-generated)
- Keep only `.csproj` file

**Host API Project** (`*.Api.csproj`) - Update reference:
```xml
<!-- Update reference from Api.Generated to Api.Contracts -->
<ProjectReference Include="..\{ProjectName}.Api.Contracts\{ProjectName}.Api.Contracts.csproj" />
```

**Domain Project** (`*.Domain.csproj`) - Add source generator and marker:
```xml
<ItemGroup>
  <PackageReference Include="Atc.Rest.Api.SourceGenerator"
                    Version="1.0.59"
                    OutputItemType="Analyzer"
                    ReferenceOutputAssembly="false" />
</ItemGroup>

<ItemGroup>
  <AdditionalFiles Include="..\ScriptAndSpecifications\{SpecFileName}.yaml" />
  <AdditionalFiles Include=".atc-rest-api-server-handlers" />
</ItemGroup>
```

**Domain Project** - Update project reference:
```xml
<!-- Update reference from Api.Generated to Api.Contracts -->
<ProjectReference Include="..\{ProjectName}.Api.Contracts\{ProjectName}.Api.Contracts.csproj" />
```

**Domain Project** - Update GlobalUsings.cs namespaces:

The migration tool performs two operations on the Domain project's `GlobalUsings.cs`:

1. **Update existing namespace references**: Existing `global using` statements that reference the old `*.Api.Generated.*` namespaces are updated to reference the new `*.Api.Contracts.Generated.*` namespaces.

2. **Add missing generated namespace usings**: Based on the OpenAPI specification, the tool automatically adds any missing `global using` statements for generated types. It uses the `PathSegmentHelper` to intelligently determine exactly which namespaces exist for each API path segment.

**Update Example** (existing usings):
```csharp
// Before
global using MyProject.Api.Generated.Accounts.Handlers;
global using MyProject.Api.Generated.Accounts.Results;

// After
global using MyProject.Api.Contracts.Generated.Accounts.Handlers;
global using MyProject.Api.Contracts.Generated.Accounts.Results;
```

**Add Example** (missing usings based on spec):
For an API with paths `/accounts` and `/devices`, the tool analyzes the OpenAPI spec and adds only the namespaces that actually exist:
```csharp
// Added based on spec analysis
global using MyProject.Api.Contracts.Generated.Accounts.Handlers;
global using MyProject.Api.Contracts.Generated.Accounts.Parameters;
global using MyProject.Api.Contracts.Generated.Accounts.Results;
global using MyProject.Api.Contracts.Generated.Devices.Handlers;
global using MyProject.Api.Contracts.Generated.Devices.Models;
global using MyProject.Api.Contracts.Generated.Devices.Parameters;
global using MyProject.Api.Contracts.Generated.Devices.Results;
```

> **Note**: The tool intelligently analyzes each path segment to determine which sub-namespaces (Handlers, Models, Parameters, Results) actually exist based on the operations defined in the OpenAPI spec. This prevents adding usings for non-existent namespaces.

> **Note**: All other using statements (System.*, FluentValidation.*, Microsoft.*, etc.) are preserved unchanged.

**Other Projects** (SignalR.Contracts, Web, etc.) - Update references:
```xml
<!-- Update any references from Api.Generated/ApiClient.Generated to new names -->
<ProjectReference Include="..\{ProjectName}.Api.Contracts\{ProjectName}.Api.Contracts.csproj" />
<ProjectReference Include="..\{ProjectName}.ApiClient\{ProjectName}.ApiClient.csproj" />
```

### 2.5 Directory.Build.props Updates (if needed)

```xml
<!-- Update to .NET 10 / C# 14 -->
<PropertyGroup>
  <TargetFramework>net10.0</TargetFramework>
  <LangVersion>14</LangVersion>
</PropertyGroup>
```

### 2.5.1 ATC Coding Rules Updater Config

**If `atc-coding-rules-updater.json` exists** - update the `projectTarget` property:

**Before**:
```json
{
  "projectTarget": "DotNet9",
  ...
}
```

**After**:
```json
{
  "projectTarget": "DotNet10",
  ...
}
```

**If `atc-coding-rules-updater.*` does NOT exist** - prompt user to set it up:

```
[yellow]![/] ATC Coding Rules Updater not configured

We recommend setting up atc-coding-rules-updater to ensure consistent
coding standards and analyzer configurations across your project.

Benefits:
  • Consistent .editorconfig and analyzer settings
  • Automatic updates when ATC rules change
  • Pre-configured for .NET 10 / C# 14

Do you want to set up atc-coding-rules-updater now? [Y/n]
```

If accepted, the migration tool will:
1. Create `atc-coding-rules-updater.json` with `projectTarget: "DotNet10"`
2. Run the existing `AtcCodingRulesUpdaterHelper` to apply the rules

This ensures the ATC coding rules updater tool stays in sync with the upgraded target framework.

### 2.6 Rollback via Git

No backup is created since projects are expected to be under git version control. If migration fails or produces unexpected results:

```bash
# Revert all changes
git checkout -- .
git clean -fd

# Or reset to the commit before migration
git reset --hard HEAD~1
```

> **Important**: The git status check (step 2) ensures users are reminded to commit all changes before migration, making rollback straightforward.

### 2.7 Dry-Run Output

```
ATC REST API
Migration Executor (Dry Run)

[yellow]⚠ Git status: 2 uncommitted changes detected[/]
  (Use --force to skip this check)

The following changes will be made:

[blue]Marker Files to Create[/]
  + src/KL.IoT.Nexus.Api.Generated/.atc-rest-api-server
  + src/KL.IoT.Nexus.ApiClient.Generated/.atc-rest-api-client
  + src/KL.IoT.Nexus.Domain/.atc-rest-api-server-handlers

[blue]Files to Delete (old generated code)[/]
  - src/KL.IoT.Nexus.Api.Generated/Contracts/ (entire folder)
  - src/KL.IoT.Nexus.Api.Generated/Endpoints/ (entire folder)
  - src/KL.IoT.Nexus.Api.Generated/Resources/ (entire folder)
  - src/KL.IoT.Nexus.Api.Generated/GlobalUsings.cs
  - src/KL.IoT.Nexus.Api.Generated/IApiContractAssemblyMarker.cs
  - src/KL.IoT.Nexus.ApiClient.Generated/Contracts/ (entire folder)
  - src/KL.IoT.Nexus.ApiClient.Generated/Endpoints/ (entire folder)
  - src/KL.IoT.Nexus.ApiClient.Generated/GlobalUsings.cs

[blue]Files to Modify[/]
  ~ src/KL.IoT.Nexus.Api.Generated/KL.IoT.Nexus.Api.Generated.csproj
    + Add PackageReference: Atc.Rest.Api.SourceGenerator (1.0.59)
    + Add AdditionalFiles for spec and marker
  ~ src/KL.IoT.Nexus.ApiClient.Generated/KL.IoT.Nexus.ApiClient.Generated.csproj
    + Add PackageReference: Atc.Rest.Api.SourceGenerator (1.0.59)
    + Add AdditionalFiles for spec and marker
  ~ src/KL.IoT.Nexus.Domain/KL.IoT.Nexus.Domain.csproj
    + Add PackageReference: Atc.Rest.Api.SourceGenerator (1.0.59)
    + Add AdditionalFiles for marker
    ~ Update ProjectReference: Api.Generated → Api.Contracts
  ~ src/KL.IoT.Nexus.Api/KL.IoT.Nexus.Api.csproj
    ~ Update ProjectReference: Api.Generated → Api.Contracts
  ~ src/KL.IoT.Nexus.SignalR.Contracts/KL.IoT.Nexus.SignalR.Contracts.csproj
    ~ Update ProjectReference: Api.Generated → Api.Contracts
  ~ src/KL.IoT.Nexus.Web/KL.IoT.Nexus.Web.csproj
    ~ Update ProjectReference: ApiClient.Generated → ApiClient
  ~ src/KL.IoT.Nexus.Domain/GlobalUsings.cs
    ~ KL.IoT.Nexus.Api.Generated.* → KL.IoT.Nexus.Api.Contracts.Generated.*
  ~ Directory.Build.props
    ~ Update TargetFramework: net9.0 → net10.0
    ~ Update LangVersion: 13 → 14
  ~ atc-coding-rules-updater.json (if present)
    ~ Update projectTarget: DotNet9 → DotNet10

[blue]Projects to Rename[/]
  ↳ src/KL.IoT.Nexus.Api.Generated/ → src/KL.IoT.Nexus.Api.Contracts/
  ↳ src/KL.IoT.Nexus.ApiClient.Generated/ → src/KL.IoT.Nexus.ApiClient/

[blue]Solution Updates[/]
  ~ KL.IoT.Nexus.slnx
    ~ Rename: KL.IoT.Nexus.Api.Generated → KL.IoT.Nexus.Api.Contracts
    ~ Rename: KL.IoT.Nexus.ApiClient.Generated → KL.IoT.Nexus.ApiClient

Summary: 3 create, 8 delete folders/files, 8 modify, 2 rename

[dim]Tip: Commit all changes to git before running migration for easy rollback.[/]

Run without --dry-run to execute migration.
```

---

## Implementation TODO List

### Phase 1: Validation Command ✓ COMPLETE

- [x] Create `MigrateValidateCommandSettings.cs` with solution path and spec path options
- [x] Create `MigrateValidateCommand.cs` with validation logic
- [x] Implement `ProjectStructureValidator` service
  - [x] Solution file detection
  - [x] Generated project detection
  - [x] Domain project detection
  - [x] Host API project detection
- [x] Implement `SpecificationValidator` service
  - [x] Spec file existence check
  - [x] YAML/JSON parsing validation
  - [x] OpenAPI schema validation
  - [x] Version extraction (3.0.x, 3.1.x)
  - [x] Multi-part spec detection (related files in same directory)
- [x] Implement `GeneratorOptionsAnalyzer` service
  - [x] Options file discovery
  - [x] Options parsing and validation
- [x] Implement `PackageReferenceAnalyzer` service
  - [x] csproj parsing
  - [x] Package version extraction
  - [x] Compatibility checking
- [x] Implement `GeneratedCodeAnalyzer` service
  - [x] Generated file detection
  - [x] Version extraction
  - [x] Assembly marker detection
- [x] Implement `HandlerAnalyzer` service
  - [x] Handler file discovery
  - [x] Interface compliance check
  - [x] Custom code detection
- [x] Implement `TargetFrameworkValidator` service
  - [x] TFM extraction from Directory.Build.props and .csproj files
  - [x] LangVersion extraction from Directory.Build.props and .csproj files
  - [x] TFM compatibility verification (< net8.0 = blocker)
  - [x] LangVersion compatibility verification (< 12 = blocker)
  - [x] Upgrade requirement detection (net8.0/net9.0 → net10.0, C# 12/13 → C# 14)
  - [x] Upgrade notification in validation output
- [x] Create `MigrationValidationReport` model (and supporting models)
- [x] Register command in `CommandAppExtensions.cs`
- [ ] Add unit tests for all validators
- [ ] Add integration test with sample old-generated project

### Phase 2: Migration Execution

- [ ] Create `MigrateExecuteCommandSettings.cs`
  - [ ] Add `--dry-run` option to preview changes without executing
  - [ ] Add `--force` option to skip confirmation prompts
- [ ] Create `MigrateExecuteCommand.cs`
  - [ ] Run Phase 1 validation first (reuse existing validators)
  - [ ] Check git status for uncommitted changes (warn user)
  - [ ] Prompt for .NET 10 / C# 14 upgrade confirmation if needed
  - [ ] Execute migration steps in sequence
  - [ ] Report progress with Spectre.Console status
- [ ] Implement `GitStatusChecker`
  - [ ] Run `git status --porcelain` to detect uncommitted changes
  - [ ] Parse output to list modified/untracked files
  - [ ] Display warning with file list
  - [ ] Require confirmation to proceed (unless --force)
- [ ] Implement `MarkerFileGenerator`
  - [ ] Generate `.atc-rest-api-server` marker from validation results
  - [ ] Generate `.atc-rest-api-client` marker if ApiClient.Generated exists
  - [ ] Generate `.atc-rest-api-server-handlers` marker for Domain project
  - [ ] Map old generator options to new marker file schema
- [ ] Implement `ProjectFileModifier`
  - [ ] Add source generator package reference with analyzer settings
  - [ ] Add `<AdditionalFiles>` for spec (from original location) and marker files
  - [ ] Update `<TargetFramework>` to net10.0 if needed
  - [ ] Update `<LangVersion>` to 14 if needed
- [ ] Implement `AtcCodingRulesHandler`
  - [ ] Check if `atc-coding-rules-updater.*` exists in solution root
  - [ ] If exists: update `projectTarget` to `DotNet10`
  - [ ] If not exists: prompt user to set it up (recommend)
  - [ ] If accepted: create config and run `AtcCodingRulesUpdaterHelper`
- [ ] Implement `GeneratedCodeCleaner`
  - [ ] Delete `Contracts/` folder from Api.Generated
  - [ ] Delete `Endpoints/` folder from Api.Generated
  - [ ] Delete `Resources/` folder from Api.Generated (if exists)
  - [ ] Delete `GlobalUsings.cs` from Api.Generated
  - [ ] Delete `IApiContractAssemblyMarker.cs` from Api.Generated
  - [ ] Delete `Contracts/` folder from ApiClient.Generated
  - [ ] Delete `Endpoints/` folder from ApiClient.Generated
  - [ ] Delete `GlobalUsings.cs` from ApiClient.Generated
  - [ ] Keep only .csproj files
- [ ] Implement `ProjectRenamer`
  - [ ] Rename `*.Api.Generated/` → `*.Api.Contracts/`
  - [ ] Rename `*.ApiClient.Generated/` → `*.ApiClient/` (if exists)
  - [ ] Rename .csproj files to match new folder names
  - [ ] Update namespace references if needed
- [ ] Implement `SolutionModifier`
  - [ ] Update solution file with renamed project paths
  - [ ] Update all project references to use new names:
    - [ ] Host Api: Api.Generated → Api.Contracts
    - [ ] Domain: Api.Generated → Api.Contracts
    - [ ] SignalR.Contracts: Api.Generated → Api.Contracts
    - [ ] Web: ApiClient.Generated → ApiClient
  - [ ] Update any solution folders if needed
- [x] Implement `GlobalUsingsModifier`
  - [x] Find GlobalUsings.cs in Domain project
  - [x] Replace `*.Api.Generated.*` → `*.Api.Contracts.Generated.*`
  - [x] Add missing generated namespace usings based on OpenAPI spec
  - [x] Use PathSegmentHelper to determine exactly which namespaces exist
  - [x] Preserve all other using statements
- [ ] Implement dry-run mode
  - [ ] Show all planned file operations (create/modify/delete)
  - [ ] Display estimated impact summary
  - [ ] Output in readable format with color coding
- [ ] Add integration tests
  - [ ] Test full migration against reference project
  - [ ] Test dry-run mode output
  - [ ] Test with/without ApiClient.Generated project

---

## Appendix A: Reference Project Analysis

**Project**: `D:\Code\KempLauritzen\kl-iot-d365-api`

| Aspect | Value |
|--------|-------|
| Solution | KL.IoT.D365.slnx |
| Target Framework | net9.0 |
| Language Version | C# 13 |
| Generator Version | 2.0.686 |
| Output Type | MinimalApi |
| Atc Package Version | 3.0.8 |
| Spec Location | src/ScriptAndSpecifications/D365.spec.api.v1.yaml |
| Options Location | src/ScriptAndSpecifications/D365ApiGeneratorOptions.json |
| Server Generated Files | 23 |
| Client Generated Files | 32 |
| Handler Count | ~2 |

**Project Structure**:
```
KL.IoT.D365/
├── KL.IoT.D365.slnx
├── src/
│   ├── KL.IoT.D365.Api/                    # Host API
│   ├── KL.IoT.D365.Api.Generated/          # Server generated
│   ├── KL.IoT.D365.ApiClient.Generated/    # Client generated
│   ├── KL.IoT.D365.Domain/                 # Handlers
│   └── ScriptAndSpecifications/
│       ├── D365.spec.api.v1.yaml           # OpenAPI spec
│       ├── D365ApiGeneratorOptions.json    # Generator options
│       └── generate-d365-api.ps1           # Generation script
└── test/
    └── ...
```

---

## Appendix B: CLI Command Reference

### Proposed Command Structure

```
atc-rest-api-gen migrate
├── validate    # Phase 1: Validate migration prerequisites
└── execute     # Phase 2: Perform migration
```

### Usage Examples

```bash
# Validate a project for migration (both solution and spec are required)
atc-rest-api-gen migrate validate -s D:\Code\MyProject -p D:\Code\MyProject\specs\api.yaml

# Validate with verbose output
atc-rest-api-gen migrate validate -s D:\Code\MyProject -p specs\api.yaml --verbose

# Save validation report to JSON file
atc-rest-api-gen migrate validate -s D:\Code\MyProject -p specs\api.yaml --output-report report.json

# Example with the reference project
atc-rest-api-gen migrate validate -s D:\Code\KempLauritzen\kl-iot-d365-api -p src\ScriptAndSpecifications\D365.spec.api.v1.yaml

# Execute migration (Phase 2)
atc-rest-api-gen migrate execute -s D:\Code\MyProject -p specs\api.yaml

# Dry-run migration (preview changes without executing)
atc-rest-api-gen migrate execute -s D:\Code\MyProject -p specs\api.yaml --dry-run

# Execute without confirmation prompts (skip git check warning)
atc-rest-api-gen migrate execute -s D:\Code\MyProject -p specs\api.yaml --force
```
