namespace Atc.Rest.Api.Generator.Cli.Extractors.TypeScript;

/// <summary>
/// Extracts OpenAPI enum schema definitions and converts them to Zod enum schema content.
/// </summary>
public static class TypeScriptZodEnumExtractor
{
    /// <summary>
    /// Extracts all enum definitions from OpenAPI document components and generates Zod schemas.
    /// </summary>
    /// <param name="openApiDoc">The OpenAPI document containing schema definitions.</param>
    /// <param name="config">TypeScript client generation configuration.</param>
    /// <returns>List of (TypeName, GeneratedContent) tuples for each enum Zod schema.</returns>
    public static List<(string Name, string Content)> Extract(
        OpenApiDocument openApiDoc,
        TypeScriptClientConfig config)
    {
        ArgumentNullException.ThrowIfNull(openApiDoc);
        ArgumentNullException.ThrowIfNull(config);

        var results = new List<(string Name, string Content)>();

        if (openApiDoc.Components?.Schemas == null || openApiDoc.Components.Schemas.Count == 0)
        {
            return results;
        }

        var headerContent = config.GenerateFileHeaders ? TypeScriptHeaderBuilder.AutoGeneratedHeader : null;

        foreach (var schema in openApiDoc.Components.Schemas)
        {
            var schemaName = schema.Key;
            var schemaValue = schema.Value;

            // Skip schema references
            if (schemaValue is OpenApiSchemaReference)
            {
                continue;
            }

            if (schemaValue is not OpenApiSchema actualSchema)
            {
                continue;
            }

            // Only process string enums
            if (actualSchema.Type != JsonSchemaType.String || actualSchema.Enum is not { Count: > 0 })
            {
                continue;
            }

            // Skip deprecated if not including them
            if (!config.IncludeDeprecated && actualSchema.Deprecated)
            {
                continue;
            }

            var enumValues = ExtractEnumValues(actualSchema.Enum);
            if (enumValues == null || enumValues.Count == 0)
            {
                continue;
            }

            var content = GenerateZodEnum(headerContent, schemaName, enumValues);
            results.Add((schemaName, content));
        }

        return results;
    }

    private static string GenerateZodEnum(
        string? headerContent,
        string schemaName,
        List<string> values)
    {
        var sb = new StringBuilder();

        if (headerContent != null)
        {
            sb.Append(headerContent);
        }

        sb.AppendLine("import { z } from 'zod';");
        sb.AppendLine();

        sb.Append("export const ").Append(schemaName).Append("Schema = z.enum([");

        for (var i = 0; i < values.Count; i++)
        {
            if (i > 0)
            {
                sb.Append(", ");
            }

            sb.Append('\'').Append(values[i]).Append('\'');
        }

        sb.AppendLine("]);");

        return sb.ToString();
    }

    private static List<string>? ExtractEnumValues(IList<JsonNode>? enumValues)
    {
        if (enumValues == null || enumValues.Count == 0)
        {
            return null;
        }

        var result = new List<string>();

        foreach (var enumValue in enumValues)
        {
            var valueStr = enumValue?.ToString();
            if (string.IsNullOrEmpty(valueStr))
            {
                continue;
            }

            var cleanValue = valueStr!.Trim('"');
            result.Add(cleanValue);
        }

        return result.Count > 0 ? result : null;
    }
}