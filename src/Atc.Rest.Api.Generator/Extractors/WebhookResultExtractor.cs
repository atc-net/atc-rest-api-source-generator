// ReSharper disable InvertIf
namespace Atc.Rest.Api.Generator.Extractors;

/// <summary>
/// Extracts webhook responses and converts them to result classes.
/// Webhook results are simpler than regular API results - they typically just return
/// acknowledgement status codes (200 OK, 202 Accepted).
/// </summary>
public static class WebhookResultExtractor
{
    /// <summary>
    /// Extracts webhook result classes from OpenAPI document.
    /// </summary>
    /// <param name="openApiDoc">The OpenAPI document containing webhook definitions.</param>
    /// <param name="projectName">The name of the project (used for namespace).</param>
    /// <param name="includeDeprecated">Whether to include deprecated webhooks.</param>
    /// <returns>List of generated result class code strings.</returns>
    public static List<(string ClassName, string Content)>? Extract(
        OpenApiDocument openApiDoc,
        string projectName,
        bool includeDeprecated = false)
    {
        if (openApiDoc == null)
        {
            throw new ArgumentNullException(nameof(openApiDoc));
        }

        if (!openApiDoc.HasWebhooks())
        {
            return null;
        }

        var resultsList = new List<(string ClassName, string Content)>();
        var namespaceValue = NamespaceBuilder.ForWebhookResults(projectName);

        foreach (var (webhookName, httpMethod, operation) in openApiDoc.GetAllWebhookOperations())
        {
            // Skip deprecated webhooks if not including them
            if (!includeDeprecated && operation.Deprecated)
            {
                continue;
            }

            var result = GenerateWebhookResultClass(
                webhookName,
                operation,
                namespaceValue);

            if (result != null)
            {
                resultsList.Add(result.Value);
            }
        }

        return resultsList.Count > 0 ? resultsList : null;
    }

    private static (string ClassName, string Content)? GenerateWebhookResultClass(
        string webhookName,
        OpenApiOperation operation,
        string namespaceValue)
    {
        // Get operation ID or generate from webhook name
        var operationId = operation.OperationId ?? $"On{webhookName.EnsureFirstCharacterToUpper()}";
        var className = $"{operationId.EnsureFirstCharacterToUpper()}WebhookResult";

        var sb = new StringBuilder();
        sb.AppendLine("// <auto-generated />");
        sb.AppendLine("#nullable enable");
        sb.AppendLine();
        sb.AppendLine("using System.CodeDom.Compiler;");
        sb.AppendLine("using System.Threading.Tasks;");
        sb.AppendLine("using Microsoft.AspNetCore.Http;");
        sb.AppendLine();
        sb.AppendLine($"namespace {namespaceValue};");
        sb.AppendLine();
        sb.AppendLine("/// <summary>");
        sb.AppendLine($"/// Result type for the {webhookName} webhook handler.");
        sb.AppendLine("/// </summary>");
        sb.AppendLine($"[GeneratedCode(\"{GeneratorInfo.Name}\", \"{GeneratorInfo.Version}\")]");
        sb.AppendLine($"public sealed class {className} : IResult");
        sb.AppendLine("{");
        sb.AppendLine(4, "private readonly IResult innerResult;");
        sb.AppendLine();
        sb.AppendLine(4, $"private {className}(IResult innerResult)");
        sb.AppendLine(4, "{");
        sb.AppendLine(8, "this.innerResult = innerResult;");
        sb.AppendLine(4, "}");

        // Generate factory methods based on responses defined in the webhook
        if (operation.Responses != null)
        {
            foreach (var response in operation.Responses)
            {
                var statusCode = response.Key;
                var responseObj = response.Value;

                if (responseObj == null)
                {
                    continue;
                }

                var methodName = GetFactoryMethodName(statusCode);
                var description = responseObj.Description ?? $"HTTP {statusCode} response";

                sb.AppendLine();
                sb.AppendLine(4, "/// <summary>");
                sb.AppendLine(4, $"/// {statusCode} - {description}");
                sb.AppendLine(4, "/// </summary>");
                sb.AppendLine(4, $"public static {className} {methodName}()");
                sb.AppendLine(8, $"=> new(TypedResults.StatusCode({GetStatusCodeInt(statusCode)}));");
            }
        }
        else
        {
            // Default to 200 OK if no responses defined
            sb.AppendLine();
            sb.AppendLine(4, "/// <summary>");
            sb.AppendLine(4, "/// 200 OK - Webhook acknowledged.");
            sb.AppendLine(4, "/// </summary>");
            sb.AppendLine(4, $"public static {className} Ok()");
            sb.AppendLine(8, "=> new(TypedResults.Ok());");
        }

        sb.AppendLine();
        sb.AppendLine(4, "public Task ExecuteAsync(HttpContext httpContext)");
        sb.AppendLine(8, "=> innerResult.ExecuteAsync(httpContext);");
        sb.AppendLine("}");

        return (className, sb.ToString());
    }

    private static string GetFactoryMethodName(string statusCode)
        => statusCode switch
        {
            "200" => "Ok",
            "201" => "Created",
            "202" => "Accepted",
            "204" => "NoContent",
            "400" => "BadRequest",
            "401" => "Unauthorized",
            "403" => "Forbidden",
            "404" => "NotFound",
            "500" => "InternalServerError",
            "default" => "Error",
            _ when int.TryParse(statusCode, out var code) => $"StatusCode{code}",
            _ => "StatusCode",
        };

    private static string GetStatusCodeInt(string statusCode)
        => statusCode switch
        {
            "200" => "200",
            "201" => "201",
            "202" => "202",
            "204" => "204",
            "400" => "400",
            "401" => "401",
            "403" => "403",
            "404" => "404",
            "500" => "500",
            "default" => "500",
            _ when int.TryParse(statusCode, out var code) => code.ToString(CultureInfo.InvariantCulture),
            _ => "200",
        };
}