namespace Atc.Rest.Api.Generator.Extractors;

/// <summary>
/// Extracts OAuth2 configuration and generates the OAuthClientOptions class.
/// This class is used with IOptions{T} pattern for runtime configuration.
/// </summary>
public static class OAuthOptionsExtractor
{
    /// <summary>
    /// Extracts OAuth options class from OAuth configuration.
    /// </summary>
    /// <param name="oauthConfig">The OAuth configuration.</param>
    /// <param name="projectName">The project name for namespace.</param>
    /// <returns>Generated code content for the OAuthClientOptions class, or null if no OAuth configured.</returns>
    public static string? Extract(
        OAuthConfig? oauthConfig,
        string projectName)
    {
        if (oauthConfig == null)
        {
            return null;
        }

        return GenerateFileContent(oauthConfig, projectName);
    }

    /// <summary>
    /// Generates the complete file content for OAuthClientOptions.
    /// </summary>
    private static string GenerateFileContent(
        OAuthConfig oauthConfig,
        string projectName)
    {
        var builder = new StringBuilder();

        builder.AppendLine("// <auto-generated />");
        builder.AppendLine("#nullable enable");
        builder.AppendLine();
        builder.AppendLine("using System.CodeDom.Compiler;");
        builder.AppendLine();
        builder.AppendLine($"namespace {projectName}.Generated.OAuth;");
        builder.AppendLine();
        builder.AppendLine("/// <summary>");
        builder.AppendLine("/// OAuth2 client configuration options.");
        builder.AppendLine("/// Configure via appsettings.json or IOptions{OAuthClientOptions} binding.");
        builder.AppendLine("/// </summary>");
        builder.AppendLine("/// <example>");
        builder.AppendLine("/// appsettings.json:");
        builder.AppendLine("/// <code>");
        builder.AppendLine("/// {");
        builder.AppendLine($"///   \"OAuth:{projectName}\": {{");
        builder.AppendLine("///     \"ClientId\": \"your-client-id\",");
        builder.AppendLine("///     \"ClientSecret\": \"your-client-secret\",");
        builder.AppendLine("///     \"Scopes\": \"scope1 scope2\"");
        builder.AppendLine("///   }");
        builder.AppendLine("/// }");
        builder.AppendLine("/// </code>");
        builder.AppendLine("/// </example>");
        builder.AppendLine($"[GeneratedCode(\"{GeneratorInfo.Name}\", \"{GeneratorInfo.Version}\")]");
        builder.AppendLine("public class OAuthClientOptions");
        builder.AppendLine("{");

        // TokenUrl property with default from OpenAPI spec
        var defaultTokenUrl = oauthConfig.EffectiveTokenUrl ?? string.Empty;
        builder.AppendLine(4, "/// <summary>");
        builder.AppendLine(4, "/// Gets or sets the OAuth2 token endpoint URL.");
        if (!string.IsNullOrEmpty(defaultTokenUrl))
        {
            builder.AppendLine(4, $"/// Default from OpenAPI spec: {defaultTokenUrl}");
        }

        builder.AppendLine(4, "/// </summary>");
        builder.AppendLine(4, $"public string TokenUrl {{ get; set; }} = \"{EscapeString(defaultTokenUrl)}\";");
        builder.AppendLine();

        // ClientId property
        builder.AppendLine(4, "/// <summary>");
        builder.AppendLine(4, "/// Gets or sets the OAuth2 client ID.");
        builder.AppendLine(4, "/// Required for Client Credentials flow.");
        builder.AppendLine(4, "/// </summary>");
        builder.AppendLine(4, "public string ClientId { get; set; } = string.Empty;");
        builder.AppendLine();

        // ClientSecret property
        builder.AppendLine(4, "/// <summary>");
        builder.AppendLine(4, "/// Gets or sets the OAuth2 client secret.");
        builder.AppendLine(4, "/// Required for Client Credentials flow.");
        builder.AppendLine(4, "/// </summary>");
        builder.AppendLine(4, "public string ClientSecret { get; set; } = string.Empty;");
        builder.AppendLine();

        // Scopes property with default from OpenAPI spec
        var defaultScopes = oauthConfig.DefaultScopeString;
        builder.AppendLine(4, "/// <summary>");
        builder.AppendLine(4, "/// Gets or sets the OAuth2 scopes (space-separated).");
        if (!string.IsNullOrEmpty(defaultScopes))
        {
            builder.AppendLine(4, $"/// Default from OpenAPI spec: \"{defaultScopes}\"");
        }

        builder.AppendLine(4, "/// </summary>");
        builder.AppendLine(4, $"public string Scopes {{ get; set; }} = \"{EscapeString(defaultScopes)}\";");
        builder.AppendLine();

        // RefreshBufferSeconds property
        builder.AppendLine(4, "/// <summary>");
        builder.AppendLine(4, "/// Gets or sets the number of seconds before token expiration to trigger a refresh.");
        builder.AppendLine(4, "/// Default: 60 seconds.");
        builder.AppendLine(4, "/// </summary>");
        builder.AppendLine(4, "public int RefreshBufferSeconds { get; set; } = 60;");

        // Only add RefreshUrl if Authorization Code flow is configured
        if (oauthConfig.SupportsRefreshTokens)
        {
            builder.AppendLine();
            builder.AppendLine(4, "/// <summary>");
            builder.AppendLine(4, "/// Gets or sets the OAuth2 refresh token endpoint URL.");
            builder.AppendLine(4, $"/// Default from OpenAPI spec: {oauthConfig.AuthorizationCodeRefreshUrl}");
            builder.AppendLine(4, "/// </summary>");
            builder.AppendLine(4, $"public string? RefreshUrl {{ get; set; }} = \"{EscapeString(oauthConfig.AuthorizationCodeRefreshUrl ?? string.Empty)}\";");
        }

        builder.AppendLine("}");

        return builder.ToString();
    }

    /// <summary>
    /// Escapes a string for use in C# string literals.
    /// </summary>
    private static string EscapeString(string value)
        => value
            .Replace("\\", "\\\\")
            .Replace("\"", "\\\"");
}