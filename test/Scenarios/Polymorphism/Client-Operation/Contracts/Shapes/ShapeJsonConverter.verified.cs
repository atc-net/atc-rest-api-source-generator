// <auto-generated />
namespace Polymorphism.Generated.Models;

/// <summary>
/// Try-parse JSON converter for the <see cref="Shape"/> union type.
/// Attempts deserialization of each variant in order until one succeeds.
/// </summary>
[GeneratedCode("Atc.Rest.Api.SourceGenerator", "1.0.0")]
public sealed class ShapeJsonConverter : JsonConverter<Shape>
{
    public override Shape? Read(ref Utf8JsonReader reader, Type typeToConvert, JsonSerializerOptions options)
    {
        using var document = JsonDocument.ParseValue(ref reader);
        var rawText = document.RootElement.GetRawText();

        JsonException? lastException = null;

        try
        {
            var result = JsonSerializer.Deserialize<Circle>(rawText, options);
            if (result is not null)
            {
                return new Shape(result);
            }
        }
        catch (JsonException ex)
        {
            lastException = ex;
        }

        try
        {
            var result = JsonSerializer.Deserialize<Square>(rawText, options);
            if (result is not null)
            {
                return new Shape(result);
            }
        }
        catch (JsonException ex)
        {
            lastException = ex;
        }

        throw new JsonException(
            $"Unable to deserialize {nameof(Shape)}: no matching variant found.",
            lastException);
    }

    public override void Write(Utf8JsonWriter writer, Shape value, JsonSerializerOptions options)
    {
        JsonSerializer.Serialize(writer, value.Value, value.Value.GetType(), options);
    }
}